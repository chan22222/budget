<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>가계부 관리</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 { margin-bottom: 20px; color: #333; }

    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .card h2 {
      font-size: 16px;
      color: #666;
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .files { display: flex; gap: 10px; flex-wrap: wrap; }
    .file-btn {
      padding: 10px 20px;
      background: #4a90d9;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .file-btn:hover { background: #357abd; }
    .file-btn.active { background: #2d6da3; }
    .file-btn.google { background: #34a853; }
    .file-btn.google:hover { background: #2d8f47; }

    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    .summary-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      text-align: center;
    }
    .summary-item .label { color: #666; font-size: 14px; }
    .summary-item .value { font-size: 24px; font-weight: bold; margin-top: 5px; }
    .summary-item .value.income { color: #28a745; }
    .summary-item .value.expense { color: #dc3545; }

    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    .toolbar select, .toolbar input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    .toolbar button {
      padding: 8px 16px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .toolbar button:hover { background: #218838; }
    .toolbar button.google-btn { background: #34a853; }
    .toolbar button.google-btn:hover { background: #2d8f47; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      padding: 10px 8px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    tr:hover { background: #f8f9fa; }

    .amount-income { color: #28a745; font-weight: 500; }
    .amount-expense { color: #dc3545; font-weight: 500; }

    select.category-select {
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 13px;
      width: 100%;
    }

    .table-container {
      max-height: 600px;
      overflow-y: auto;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .file-tabs {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    .file-tab {
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: #f8f9fa;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    .file-tab:hover {
      background: #e9ecef;
    }
    .file-tab.active {
      background: #4a90d9;
      color: white;
      border-color: #4a90d9;
    }
    .file-tab.need-password {
      background: #fff3cd;
      border-color: #ffc107;
      color: #856404;
    }

    .google-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      padding: 5px 10px;
      border-radius: 20px;
      background: #f1f1f1;
    }
    .google-status.connected { background: #d4edda; color: #155724; }
    .google-status.disconnected { background: #f8d7da; color: #721c24; }
    .google-status .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
    }
    .modal-content h3 { margin-bottom: 20px; }
    .modal-content p { margin-bottom: 15px; color: #666; }
    .modal-content .btn-group { display: flex; gap: 10px; justify-content: flex-end; }
    .modal-content button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .modal-content .btn-cancel { background: #6c757d; color: white; }
    .modal-content .btn-confirm { background: #34a853; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <h1>가계부 관리 도구</h1>

    <div class="card">
      <h2>
        파일 선택
        <span class="google-status disconnected" id="googleStatus">
          <span class="dot"></span>
          <span>Google 연결 안됨</span>
        </span>
      </h2>
      <div class="files" id="fileList">
        <label class="file-btn" style="cursor:pointer;">
          파일 업로드
          <input type="file" id="fileUpload" accept=".xlsx,.xls" multiple style="display:none;" onchange="uploadFiles(this.files)">
        </label>
        <button class="file-btn google" onclick="connectGoogle()" id="btnGoogleConnect">Google 연결</button>
      </div>
      <div style="margin-top:15px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <label style="font-size:14px; color:#666;">스프레드시트 ID:</label>
        <input type="text" id="spreadsheetId" placeholder="스프레드시트 ID 입력" style="flex:1; min-width:200px; max-width:400px; padding:8px 12px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
        <label style="font-size:14px; color:#666; margin-left:10px;">시트:</label>
        <select id="targetMonth" style="padding:8px 12px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
          <option value="1월">1월</option>
          <option value="2월">2월</option>
          <option value="3월">3월</option>
          <option value="4월">4월</option>
          <option value="5월">5월</option>
          <option value="6월">6월</option>
          <option value="7월">7월</option>
          <option value="8월">8월</option>
          <option value="9월">9월</option>
          <option value="10월">10월</option>
          <option value="11월">11월</option>
          <option value="12월">12월</option>
        </select>
        <button class="file-btn" onclick="saveSettings()" style="background:#6c757d;">저장</button>
      </div>
    </div>

    <div class="card">
      <h2>요약</h2>
      <div class="summary">
        <div class="summary-item">
          <div class="label">총 수입</div>
          <div class="value income" id="totalIncome">0원</div>
        </div>
        <div class="summary-item">
          <div class="label">총 지출</div>
          <div class="value expense" id="totalExpense">0원</div>
        </div>
        <div class="summary-item">
          <div class="label">잔액</div>
          <div class="value" id="balance">0원</div>
        </div>
        <div class="summary-item">
          <div class="label">거래 수</div>
          <div class="value" id="txCount">0건</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>거래 내역</h2>
      <div id="fileTabs" class="file-tabs" style="display:none; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
        <button class="file-tab active" data-file="all">전체</button>
      </div>
      <div class="toolbar">
        <select id="filterMonth">
          <option value="">전체 월</option>
          <option value="01">1월</option>
          <option value="02">2월</option>
          <option value="03">3월</option>
          <option value="04">4월</option>
          <option value="05">5월</option>
          <option value="06">6월</option>
          <option value="07">7월</option>
          <option value="08">8월</option>
          <option value="09">9월</option>
          <option value="10">10월</option>
          <option value="11">11월</option>
          <option value="12">12월</option>
        </select>
        <select id="filterCategory">
          <option value="">전체 카테고리</option>
        </select>
        <input type="text" id="searchText" placeholder="검색..." />
        <button onclick="exportExcel()">Excel 내보내기</button>
        <button class="google-btn" onclick="syncToGoogle()" id="btnSyncGoogle" disabled>스프레드시트에 추가</button>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width:90px">날짜</th>
              <th style="width:100px">대분류</th>
              <th style="width:100px">소분류</th>
              <th>내용</th>
              <th style="width:100px">수입</th>
              <th style="width:100px">지출</th>
              <th style="width:90px">지출수단</th>
              <th style="width:80px">지출성격</th>
              <th>비고</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="9" class="loading">파일을 선택해주세요</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div class="modal" id="passwordModal">
    <div class="modal-content">
      <h3>비밀번호 입력</h3>
      <p><strong id="pwFileName"></strong> 파일의 비밀번호를 입력해주세요.</p>
      <input type="password" id="pwInput" style="width:100%;padding:10px;margin:15px 0;border:1px solid #ddd;border-radius:5px;font-size:14px;" placeholder="비밀번호" onkeypress="if(event.key==='Enter')submitPassword()">
      <div class="btn-group">
        <button class="btn-cancel" onclick="skipPasswordFile()">건너뛰기</button>
        <button class="btn-confirm" onclick="submitPassword()">확인</button>
      </div>
    </div>
  </div>

  <!-- Google Sync Modal -->
  <div class="modal" id="syncModal">
    <div class="modal-content">
      <h3>스프레드시트에 추가</h3>
      <p>현재 보이는 <strong id="syncCount">0</strong>건의 거래를 Google 스프레드시트에 추가합니다.</p>
      <div style="margin-bottom:20px">
        <label>추가할 시트:</label>
        <select id="targetSheet" style="width:100%;padding:10px;margin-top:5px">
          <option value="1월">1월</option>
          <option value="2월">2월</option>
          <option value="3월">3월</option>
          <option value="4월">4월</option>
          <option value="5월">5월</option>
          <option value="6월">6월</option>
          <option value="7월">7월</option>
          <option value="8월">8월</option>
          <option value="9월">9월</option>
          <option value="10월">10월</option>
          <option value="11월">11월</option>
          <option value="12월">12월</option>
        </select>
      </div>
      <div class="btn-group">
        <button class="btn-cancel" onclick="closeSyncModal()">취소</button>
        <button class="btn-confirm" onclick="confirmSync()">추가하기</button>
      </div>
    </div>
  </div>

  <script>
    let allData = [];
    let fileData = {};  // 파일별 데이터
    let currentFile = 'all';  // 현재 선택된 파일
    let categories = {};
    let googleConnected = false;

    // 파일 업로드 큐
    let uploadQueue = [];
    let currentUploadFile = null;
    let currentFilePath = null;  // 서버에 저장된 파일 경로
    let currentFileName = null;
    let uploadResults = [];

    // 초기화
    async function init() {
      // 페이지 로드 시 import 폴더 비우기
      await fetch('/api/files', { method: 'DELETE' });

      await loadFiles();
      await loadCategories();
      await checkGoogleStatus();
      setupFilters();
      setCurrentMonth();

      // URL 파라미터 체크
      if (location.search.includes('google=connected')) {
        history.replaceState({}, '', '/');
        await checkGoogleStatus();
      }
    }

    // 현재 월로 기본 설정
    function setCurrentMonth() {
      const currentMonth = new Date().getMonth() + 1; // 1-12
      document.getElementById('targetMonth').value = currentMonth + '월';
      document.getElementById('targetSheet').value = currentMonth + '월';
    }

    // 파일 목록 로드
    async function loadFiles() {
      const res = await fetch('/api/files');
      const files = await res.json();

      const container = document.getElementById('fileList');
      files.forEach(file => {
        const btn = document.createElement('button');
        btn.className = 'file-btn';
        btn.textContent = file.name;
        btn.onclick = () => loadFile(file.name);
        container.insertBefore(btn, container.lastElementChild);
      });
    }

    // 카테고리 로드
    async function loadCategories() {
      const res = await fetch('/api/categories');
      categories = await res.json();

      const select = document.getElementById('filterCategory');
      Object.keys(categories).forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
      });
    }

    // Google 연결 상태 확인
    async function checkGoogleStatus() {
      try {
        const res = await fetch('/api/google/status');
        const status = await res.json();

        googleConnected = status.authenticated;
        const statusEl = document.getElementById('googleStatus');
        const btnConnect = document.getElementById('btnGoogleConnect');
        const btnSync = document.getElementById('btnSyncGoogle');

        // 스프레드시트 ID 표시
        if (status.spreadsheetId) {
          document.getElementById('spreadsheetId').value = status.spreadsheetId;
        }

        if (googleConnected) {
          statusEl.className = 'google-status connected';
          statusEl.innerHTML = '<span class="dot"></span><span>Google 연결됨</span>';
          btnConnect.textContent = '연결됨';
          btnConnect.disabled = true;
          btnSync.disabled = false;
        } else {
          statusEl.className = 'google-status disconnected';
          statusEl.innerHTML = '<span class="dot"></span><span>Google 연결 안됨</span>';
          btnConnect.textContent = 'Google 연결';
          btnConnect.disabled = false;
          btnSync.disabled = true;
        }
      } catch (e) {
        console.error('Google 상태 확인 실패:', e);
      }
    }

    // 설정 저장 (스프레드시트 ID)
    async function saveSettings() {
      const id = document.getElementById('spreadsheetId').value.trim();
      if (!id) {
        alert('스프레드시트 ID를 입력해주세요.');
        return;
      }

      const res = await fetch('/api/google/spreadsheet-id', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ spreadsheetId: id })
      });

      const result = await res.json();
      if (result.success) {
        alert('설정이 저장되었습니다.');
      }
    }

    // 파일 업로드 (순차 처리)
    async function uploadFiles(files) {
      if (!files.length) return;

      // 초기화
      uploadQueue = Array.from(files);
      uploadResults = [];
      allData = [];
      fileData = {};
      currentFile = 'all';
      currentFilePath = null;
      currentFileName = null;

      document.getElementById('tableBody').innerHTML = '<tr><td colspan="9" class="loading">업로드 중...</td></tr>';

      // 첫 번째 파일부터 처리
      await processNextFile();
    }

    // 다음 파일 처리
    async function processNextFile(password = '') {
      if (uploadQueue.length === 0) {
        // 모든 파일 처리 완료
        finishUpload();
        return;
      }

      currentUploadFile = uploadQueue.shift();
      const formData = new FormData();
      formData.append('file', currentUploadFile);
      if (password) {
        formData.append('password', password);
      }

      try {
        const res = await fetch('/api/parse-file', {
          method: 'POST',
          body: formData
        });

        const result = await res.json();

        if (result.needPassword) {
          // 비밀번호 필요 - 서버 파일 경로 저장 후 모달 표시
          currentFilePath = result.filePath;
          currentFileName = result.name;
          document.getElementById('pwFileName').textContent = result.name;
          document.getElementById('pwInput').value = '';
          document.getElementById('passwordModal').classList.add('show');
          document.getElementById('pwInput').focus();
        } else if (result.success) {
          // 성공
          uploadResults.push({ name: result.name, status: 'success', count: result.count });
          fileData[result.name] = result.data;
          allData = allData.concat(result.data);
          // 다음 파일
          await processNextFile();
        } else {
          // 에러
          uploadResults.push({ name: currentUploadFile.name, status: 'error', error: result.error });
          await processNextFile();
        }
      } catch (e) {
        uploadResults.push({ name: currentUploadFile.name, status: 'error', error: e.message });
        await processNextFile();
      }
    }

    // 비밀번호 제출
    async function submitPassword() {
      const password = document.getElementById('pwInput').value;
      document.getElementById('passwordModal').classList.remove('show');

      if (!password) {
        // 비밀번호 없으면 건너뛰기
        uploadResults.push({ name: currentFileName, status: 'skipped' });
        await processNextFile();
        return;
      }

      // 서버에 저장된 파일 경로로 재파싱 요청
      try {
        const res = await fetch('/api/parse-saved', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filePath: currentFilePath,
            password: password,
            fileName: currentFileName
          })
        });

        const result = await res.json();

        if (result.needPassword) {
          // 비밀번호 틀림 - 다시 모달 표시
          const errMsg = result.originalError ? `\n(오류: ${result.originalError})` : '';
          alert('비밀번호가 틀렸습니다.' + errMsg);
          document.getElementById('pwInput').value = '';
          document.getElementById('passwordModal').classList.add('show');
          document.getElementById('pwInput').focus();
        } else if (result.success) {
          // 성공
          uploadResults.push({ name: result.name, status: 'success', count: result.count });
          fileData[result.name] = result.data;
          allData = allData.concat(result.data);
          // 다음 파일
          await processNextFile();
        } else {
          // 에러
          uploadResults.push({ name: currentFileName, status: 'error', error: result.error });
          await processNextFile();
        }
      } catch (e) {
        uploadResults.push({ name: currentFileName, status: 'error', error: e.message });
        await processNextFile();
      }
    }

    // 파일 건너뛰기
    async function skipPasswordFile() {
      document.getElementById('passwordModal').classList.remove('show');
      uploadResults.push({ name: currentFileName, status: 'skipped' });
      await processNextFile();
    }

    // 업로드 완료
    function finishUpload() {
      // 날짜순 정렬
      allData.sort((a, b) => (a._fullDate || '').localeCompare(b._fullDate || ''));

      // 파일 탭 생성
      renderFileTabs(uploadResults);

      renderTable();
      updateSummary();

      // 결과 알림
      const successCount = uploadResults.filter(r => r.status === 'success').length;
      const totalCount = allData.length;
      const skippedFiles = uploadResults.filter(r => r.status === 'skipped').map(r => r.name);

      if (skippedFiles.length > 0) {
        alert(`${totalCount}건 로드됨 (${successCount}개 파일)\n건너뛴 파일: ${skippedFiles.join(', ')}`);
      } else if (successCount > 0) {
        alert(`${totalCount}건의 거래가 로드되었습니다.`);
      } else {
        alert('로드된 데이터가 없습니다.');
      }
    }

    // 파일 탭 렌더링
    function renderFileTabs(files) {
      const container = document.getElementById('fileTabs');
      const successFiles = files.filter(f => f.status === 'success');

      if (successFiles.length <= 1) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'flex';
      container.innerHTML = '<button class="file-tab active" data-file="all" onclick="selectFileTab(\'all\')">전체</button>';

      for (const file of files) {
        const btn = document.createElement('button');
        btn.className = 'file-tab';
        if (file.status === 'need_password') {
          btn.className += ' need-password';
          btn.textContent = `${file.name} (비밀번호 필요)`;
        } else if (file.status === 'success') {
          btn.textContent = `${file.name} (${file.count}건)`;
          btn.setAttribute('data-file', file.name);
          btn.onclick = () => selectFileTab(file.name);
        } else {
          btn.textContent = `${file.name} (오류)`;
          btn.style.opacity = '0.5';
        }
        container.appendChild(btn);
      }
    }

    // 파일 탭 선택
    function selectFileTab(fileName) {
      currentFile = fileName;

      // 탭 활성화 상태 업데이트
      document.querySelectorAll('.file-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-file') === fileName) {
          tab.classList.add('active');
        }
      });

      renderTable();
      updateSummary();
    }

    // 현재 파일 데이터 가져오기
    function getCurrentData() {
      if (currentFile === 'all') {
        return allData;
      }
      return fileData[currentFile] || [];
    }

    // Google 연결
    function connectGoogle() {
      window.location.href = '/api/google/auth';
    }

    // 단일 파일 로드
    async function loadFile(filename) {
      document.getElementById('tableBody').innerHTML = '<tr><td colspan="9" class="loading">로딩 중...</td></tr>';

      const res = await fetch(`/api/parse/${encodeURIComponent(filename)}`);
      const result = await res.json();

      if (result.error) {
        alert(result.error);
        return;
      }

      allData = result.data;
      renderTable();
      updateSummary();
    }

    // 전체 파일 로드
    async function loadAllFiles() {
      document.getElementById('tableBody').innerHTML = '<tr><td colspan="9" class="loading">로딩 중...</td></tr>';

      const res = await fetch('/api/parse-all');
      const result = await res.json();

      if (result.error) {
        alert(result.error);
        return;
      }

      allData = result.data;
      renderTable();
      updateSummary();
    }

    // 필터 설정
    function setupFilters() {
      document.getElementById('filterMonth').onchange = renderTable;
      document.getElementById('filterCategory').onchange = renderTable;
      document.getElementById('searchText').oninput = renderTable;
    }

    // 필터된 데이터 가져오기
    function getFilteredData() {
      const month = document.getElementById('filterMonth').value;
      const category = document.getElementById('filterCategory').value;
      const search = document.getElementById('searchText').value.toLowerCase();
      const data = getCurrentData();

      return data.filter(row => {
        // 월 필터링 (_fullDate 사용)
        if (month) {
          const fullDate = row._fullDate || '';
          if (!fullDate.includes(`-${month}-`)) return false;
        }
        if (category && row.대분류 !== category) return false;
        if (search) {
          const text = `${row.내용} ${row.비고} ${row.소분류}`.toLowerCase();
          if (!text.includes(search)) return false;
        }
        return true;
      });
    }

    // 테이블 렌더링
    function renderTable() {
      const data = getFilteredData();
      const tbody = document.getElementById('tableBody');

      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="loading">데이터가 없습니다</td></tr>';
        return;
      }

      tbody.innerHTML = data.map((row, idx) => `
        <tr data-idx="${idx}">
          <td>${formatDate(row.날짜)}</td>
          <td>
            <select class="category-select" onchange="updateCategory(${idx}, 'main', this.value)">
              ${Object.keys(categories).map(c =>
                `<option value="${c}" ${c === row.대분류 ? 'selected' : ''}>${c}</option>`
              ).join('')}
            </select>
          </td>
          <td>
            <select class="category-select" onchange="updateCategory(${idx}, 'sub', this.value)">
              ${(categories[row.대분류] || ['기타']).map(s =>
                `<option value="${s}" ${s === row.소분류 ? 'selected' : ''}>${s}</option>`
              ).join('')}
            </select>
          </td>
          <td>${row.내용}</td>
          <td class="amount-income">${row.수입금액 ? formatNumber(row.수입금액) : ''}</td>
          <td class="amount-expense">${row.지출금액 ? formatNumber(row.지출금액) : ''}</td>
          <td>${row.지출수단 || ''}</td>
          <td>${row.지출성격 || ''}</td>
          <td>${row.비고 || ''}</td>
        </tr>
      `).join('');

      updateSummary();
    }

    // 날짜 포맷 (MM-DD)
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const parts = dateStr.split('-');
      if (parts.length >= 3) {
        return `${parts[1]}-${parts[2]}`;
      }
      return dateStr;
    }

    // 카테고리 업데이트
    function updateCategory(idx, type, value) {
      if (type === 'main') {
        allData[idx].대분류 = value;
        allData[idx].소분류 = categories[value]?.[0] || '기타';
      } else {
        allData[idx].소분류 = value;
      }
      renderTable();
    }

    // 요약 업데이트
    function updateSummary() {
      const data = getFilteredData();

      const totalIncome = data.reduce((sum, row) => sum + (Number(row.수입금액) || 0), 0);
      const totalExpense = data.reduce((sum, row) => sum + (Number(row.지출금액) || 0), 0);

      document.getElementById('totalIncome').textContent = formatNumber(totalIncome) + '원';
      document.getElementById('totalExpense').textContent = formatNumber(totalExpense) + '원';
      document.getElementById('balance').textContent = formatNumber(totalIncome - totalExpense) + '원';
      document.getElementById('txCount').textContent = data.length + '건';
    }

    // 숫자 포맷
    function formatNumber(num) {
      return Number(num).toLocaleString('ko-KR');
    }

    // Excel 내보내기
    async function exportExcel() {
      const data = getFilteredData();
      const month = document.getElementById('filterMonth').value || 'all';

      const res = await fetch('/api/export', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ data, month })
      });

      const result = await res.json();
      if (result.success) {
        alert(`저장 완료: ${result.path}`);
      } else {
        alert('내보내기 실패: ' + result.error);
      }
    }

    // Google Sheets 동기화 모달
    function syncToGoogle() {
      if (!googleConnected) {
        alert('먼저 Google에 연결해주세요.');
        return;
      }

      const data = getFilteredData();
      document.getElementById('syncCount').textContent = data.length;

      // 상단에서 선택한 시트로 기본값 설정
      const targetMonth = document.getElementById('targetMonth').value;
      document.getElementById('targetSheet').value = targetMonth;

      document.getElementById('syncModal').classList.add('show');
    }

    function closeSyncModal() {
      document.getElementById('syncModal').classList.remove('show');
    }

    // 실제 동기화 실행
    async function confirmSync() {
      const data = getFilteredData();
      const selectedMonth = document.getElementById('targetSheet').value;
      const targetMonthNum = parseInt(selectedMonth); // "1월" -> 1

      // 선택한 월에 해당하는 데이터만 필터링 (_fullDate 사용)
      const filteredData = data.filter(row => {
        const fullDate = row._fullDate || '';
        if (!fullDate) return false;
        const parts = fullDate.split('-');
        if (parts.length >= 2) {
          const dataMonth = parseInt(parts[1]);
          return dataMonth === targetMonthNum;
        }
        return false;
      });

      if (filteredData.length === 0) {
        alert(`${selectedMonth} 데이터가 없습니다.`);
        return;
      }

      // _fullDate는 서버에 보내지 않음
      const formattedData = filteredData.map(row => {
        const { _fullDate, ...rest } = row;
        return rest;
      });

      try {
        const res = await fetch('/api/google/append', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ month: selectedMonth, data: formattedData })
        });

        const result = await res.json();
        if (result.error) {
          alert('동기화 실패: ' + result.error);
        } else {
          const added = result.addedCount || 0;
          const skipped = result.skippedCount || 0;
          const existingCount = result.existingCount || 0;
          const duplicates = result.duplicates || [];

          let msg = '';
          if (added > 0) {
            msg = `${selectedMonth} 시트에 ${added}건 추가 완료!`;
          }

          if (skipped > 0) {
            msg += `\n\n중복 제외: ${skipped}건`;
            // 중복 항목 상세 (최대 5개)
            const showDups = duplicates.slice(0, 5);
            showDups.forEach(d => {
              msg += `\n  - ${d.new}`;
            });
            if (duplicates.length > 5) {
              msg += `\n  ... 외 ${duplicates.length - 5}건`;
            }
          }

          if (added === 0 && skipped === 0) {
            msg = `시트에 기존 데이터 ${existingCount}건 있음\n추가할 새 데이터가 없습니다.`;
          } else if (added === 0 && skipped > 0) {
            msg = `모든 데이터(${skipped}건)가 이미 존재합니다.\n\n시트 기존 데이터: ${existingCount}건`;
            const showDups = duplicates.slice(0, 5);
            showDups.forEach(d => {
              msg += `\n  - ${d.new}`;
            });
            if (duplicates.length > 5) {
              msg += `\n  ... 외 ${duplicates.length - 5}건`;
            }
          }

          alert(msg);
        }
      } catch (e) {
        alert('동기화 실패: ' + e.message);
      }
      closeSyncModal();
    }

    init();
  </script>
</body>
</html>
